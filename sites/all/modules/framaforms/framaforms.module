<?php


/**
  Loose attempt Load a given CSS if page is embeded in iframe - Kept for later
*/
/*
function framaforms_init() {

  //here put any condition to you want, for example a domain
  $url = url("<front>", array('absolute' => TRUE));
drupal_set_message('base URL '.$url);

  if( $url == "http://beta.framaforms.org/") {
    drupal_set_message('Notre formulaire est import√©...');
    drupal_add_css(drupal_get_path('theme', 'framaforms_embed') . '/embed.css'); 
  }
}
*/

function framaforms_preprocess_page(&$vars, $hook) {

   $url = url("<front>", array('absolute' => TRUE)); //get base URL of the current website
   //drupal_set_message('base URL '.$url);

   // if the current base url contain  "framaforms.org", add the framanav
   if( strpos( $url, "framaforms.org" ) !== false) {
     drupal_add_js('https://framasoft.org/nav/nav.js', 'external');
   }
}

/**
 * Hide Webforms IP
*/
function framaforms_webform_submission_load(&$submissions) {
  global $user;
  $submission = current($submissions);

  if (in_array('administrator', $user->roles)) {
    // do we need to anonymze ?

  } else {
      foreach ($submissions as $sid => $submission) {
      // If called for, anonymize uid and ip of submission before display.
      $submission->uid = 0;
      $submission->name = 'Anonymous';
      $submission->remote_addr = '0.0.0.0';
    }
  }
  
}


/**
* Add specific views access if the visitor is the author of the node
*/
function framaforms_views_access_callbacks() {
  return array(
    'framaforms_user_has_access' => t('Current user is author of the node'),
  );
}

function framaforms_user_has_access($account = NULL) {
  global $user;
    $node = node_load(arg(1));
    if ( (isset($node->uid, $GLOBALS['user']->uid) && $GLOBALS['user']->uid == $node->uid && $GLOBALS['user']->uid > 0) || (user_has_role(3) ) ) {
    return TRUE;
  }
  return FALSE;
}

/**
* Disable wysiwyg on markup widget and add protection before leaving
*/
function framaforms_form_alter(&$form, &$form_state, $context) {
// if ($form_id['#id'] == 'form1') {
    $form_id['edit-markup-value']['#wysiwyg'] = FALSE;
    $form_id['edit-markup-value']['und'][0]['#wysiwyg'] = false;
    $form_id['markup']['#wysiwyg'] = FALSE;
    $form_id['markup']['und'][0]['#wysiwyg'] = false;
    $form_id['form-builder-element-markup']['#type'] = 'text_format';    
//  } 

  // loose attempt to add protection if user leave within editing a webform :-/
  // dpm($form);
  //if(isset($form_id['form_builder_preview'])) {
  //     drupal_add_js(drupal_get_path('module', 'node_edit_protection') . '/node-edit-protection.js');
  //}


}
